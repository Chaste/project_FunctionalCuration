<?xml version="1.0"?>
<?xml-model href="../../../src/proto/parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#"
    xmlns:cellml="http://www.cellml.org/cellml/1.0#"
    xmlns:oxmeta="https://chaste.comlab.ox.ac.uk/cellml/ns/oxford-metadata#">
    <!-- Declare protocol inputs with default values -->
    <inputs>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            <apply><eq/>
                <ci>pacing_period</ci>
                <cn>1000</cn>
            </apply>
            <apply><eq/>
                <ci>steady_state_beats</ci>
                <cn>1000</cn>
            </apply>
            <apply><eq/>
                <ci>extra_potassium_test_concentrations</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                    <cn>10</cn>
                    <cn>9</cn>
                    <cn>8</cn>
                    <cn>7</cn>
                    <cn>6</cn>
                    <cn>5</cn>
                    <cn>4</cn>
                    <cn>3</cn>
                    <cn>2</cn>
                </apply>
            </apply>
        </apply>    
    </inputs>
    
    <import source="../../../src/proto/library/BasicLibrary.xml" mergeDefinitions="true"/>
    <import source="../../../src/proto/library/CardiacLibrary.xml" mergeDefinitions="true"/>
    
    <library>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            <apply><eq/>
                <ci>default_Ko</ci>
                <ci>sim:oxmeta:extracellular_potassium_concentration</ci>
            </apply>
            <apply><eq/>
                <ci>potassium_test_concentrations</ci>
                <apply><ci>Sort</ci>
                    <apply><ci>Join</ci>
                        <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                            <ci>default_Ko</ci>
                        </apply>
                        <ci>extra_potassium_test_concentrations</ci>
                    </apply>
                </apply>
            </apply>
        </apply>
    </library>
     
    <units>
        <cellml:units name="mV">
            <cellml:unit units="volt" prefix="milli"/>
        </cellml:units>
        <cellml:units name="ms">
            <cellml:unit units="second" prefix="milli"/>
        </cellml:units>
	   <cellml:units name="mM">
	      <cellml:unit units="mole" prefix="milli"/>
	      <cellml:unit units="litre" exponent="-1"/>
	   </cellml:units>
    </units>
    
    <modelInterface>
        <!-- Here we've commented out the stimulus end time because we don't ever want it to finish, for other protocols you might want to re-include it. -->
        <!-- <specifyInputVariable name="oxmeta:membrane_stimulus_current_end" units="ms" initial_value="100000000000"/> -->
        <specifyInputVariable name="oxmeta:membrane_stimulus_current_offset" units="ms" initial_value="10"/>
        <specifyInputVariable name="oxmeta:membrane_stimulus_current_period" units="ms" initial_value="1000"/>
        <specifyInputVariable name="oxmeta:extracellular_potassium_concentration" units="mM"/>
        <specifyOutputVariable name="oxmeta:membrane_voltage" units="mV"/>
        <specifyOutputVariable name="oxmeta:time" units="ms"/>
        <specifyOutputVariable name="oxmeta:extracellular_potassium_concentration" units="mM"/>
        <addOrReplaceEquation>
            <apply xmlns="http://www.w3.org/1998/Math/MathML"><eq/>
                <ci>oxmeta:membrane_stimulus_current</ci>
                <piecewise>
                    <piece>
                        <ci>oxmeta:membrane_stimulus_current_amplitude</ci>
                        <apply><and/>
                            <apply><geq/>
                                <ci>oxmeta:time</ci>
                                <ci>oxmeta:membrane_stimulus_current_offset</ci>
                            </apply>
                        <!--<apply><leq/>
                                <ci>oxmeta:time</ci>
                                <ci>oxmeta:membrane_stimulus_current_end</ci>
                            </apply> -->
                            <apply><leq/>
                                <apply><minus/>
                                    <apply><minus/>
                                        <ci>oxmeta:time</ci>
                                        <ci>oxmeta:membrane_stimulus_current_offset</ci>
                                    </apply>
                                    <apply><times/>
                                        <apply><floor/>
                                            <apply><divide/>
                                                <apply><minus/>
                                                    <ci>oxmeta:time</ci>
                                                    <ci>oxmeta:membrane_stimulus_current_offset</ci>
                                                </apply>
                                                <ci>oxmeta:membrane_stimulus_current_period</ci>
                                            </apply>
                                        </apply>
                                        <ci>oxmeta:membrane_stimulus_current_period</ci>
                                    </apply>
                                </apply>
                                <ci>oxmeta:membrane_stimulus_current_duration</ci>
                            </apply>
                        </apply>
                    </piece>
                    <otherwise>
                        <apply><times/>
                            <cn cellml:units="dimensionless">0</cn>
                            <ci>oxmeta:membrane_stimulus_current_amplitude</ci>
                        </apply>
                    </otherwise>
                </piecewise>
            </apply>
        </addOrReplaceEquation>
    </modelInterface>

    <simulations>    
    	<!-- Do a pre-run to get the model to steady-state with the desired S1 stimulus -->
		<timecourseSimulation>
		    <vectorStepper name="time" units="ms">
		        <value>0</value>
		        <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
		            <ci>pacing_period</ci>
		            <ci>steady_state_beats</ci>
		        </apply>
		    </vectorStepper>
		    <modifiers>
		        <!-- Set stimulus period to S1 interval, offset 10ms -->                    
		        <setVariable>
		            <when>AT_START_ONLY</when>
		            <name>oxmeta:membrane_stimulus_current_period</name><!-- ms -->
		            <value>
		                <ci xmlns="http://www.w3.org/1998/Math/MathML">pacing_period</ci>
		            </value>
		        </setVariable>         
		        <saveState>
		            <when>AT_END</when>
		            <name>initial_state</name>
		        </saveState>
		    </modifiers>
		</timecourseSimulation>
        
	    <nestedSimulation prefix="sim">
	        <vectorStepper name="step_potassium" units="mM">
                <ci xmlns="http://www.w3.org/1998/Math/MathML">potassium_test_concentrations</ci>
	        </vectorStepper>
	        
	        <modifiers>
	            <!-- Set the external potassium concentration -->
	            <setVariable>
	                <when>EVERY_LOOP</when>
	                <name>oxmeta:extracellular_potassium_concentration</name>
	                <value>
	                    <ci xmlns="http://www.w3.org/1998/Math/MathML">step_potassium</ci>
	                </value>
	            </setVariable>
	        </modifiers>
	    
	        <!-- Do a run to get the model to steady-state with the desired extracellular potassium -->
	        <timecourseSimulation>            
	            <vectorStepper name="time" units="ms">
	                <apply xmlns="http://www.w3.org/1998/Math/MathML"><ci>Join</ci>
	                    <apply>
	                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
	                        <cn>0</cn>
	                        <apply><times/>
	                            <ci>pacing_period</ci>
	                            <ci>steady_state_beats</ci>
	                        </apply>
	                    </apply>
	                    <apply>
                            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                            <domainofapplication>
                                <!-- #0#t = bcl*st_st_beats+1 : 1 : bcl*(st_st_beats+1) -->
                                <apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                                    <cn>0</cn>
                                    <apply><plus/>
                                        <apply><times/>
                                            <ci>pacing_period</ci>
                                            <ci>steady_state_beats</ci>
                                        </apply>
                                        <cn>1</cn>
                                    </apply>
                                    <cn>1</cn>
                                    <apply><times/>
                                        <ci>pacing_period</ci>
                                        <apply><plus/>
                                            <ci>steady_state_beats</ci>
                                            <cn>1</cn>
                                        </apply>
                                    </apply>
                                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/string">t</csymbol>
                                </apply>
                            </domainofapplication>
                            <ci>t</ci>
                        </apply>
	                </apply>
	            </vectorStepper>
	            
	            <modifiers>
		            <resetState> <!-- At the beginning of the final AP simulation load up the state variables from the long run to steady state -->
		                <when>AT_START_ONLY</when>
		                <state>initial_state</state>
		            </resetState>	                
	            </modifiers>        
	        </timecourseSimulation>
      	</nestedSimulation>        
    </simulations>
    
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- Test that expected model outputs exist -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:membrane_voltage</ci>
                </apply>
            </apply>
            
            <!-- Calculate the time at which there will be one further action potential -->
            <apply><eq/>
                <ci>min_time</ci>
                <apply xmlns="http://www.w3.org/1998/Math/MathML"><times/>
                    <ci>pacing_period</ci>
                    <ci>steady_state_beats</ci>
	            </apply>
            </apply>
            
            <!-- Reduce these arrays to just the 'steady' action potential -->
            <apply><eq/>
                <ci>steady_state_membrane_voltage</ci>
                <apply><ci>After</ci>
                    <ci>sim:membrane_voltage</ci>
                    <ci>sim:time</ci>
                    <ci>min_time</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>            
            
            <apply><eq/>
                <ci>last_pace_time</ci>
                <apply><ci>After</ci>
                    <ci>sim:time</ci>
                    <ci>sim:time</ci>
                    <ci>min_time</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            
            <!-- Translate time so that it starts at zero for this last steady pace -->
            <apply><eq/>
                <ci>steady_state_time_2d</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/map"/>
                    <lambda>
                        <bvar><ci>element_value</ci></bvar>
                        <apply><minus/>
                            <ci>element_value</ci>
                            <ci>min_time</ci>
                        </apply>
                    </lambda>
                    <ci>last_pace_time</ci>
                </apply>
            </apply>
            
            <!-- Prepare a 1d time vector for plotting as independent variable -->
            <apply><eq/>
                <ci>steady_state_time</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                    <ci>steady_state_time_2d</ci>
                    <apply>
                        <!-- Take the first time column loop - they all use the same times -->
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <cn>0</cn><cn>0</cn><cn>0</cn><cn>0</cn>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                    </apply>                    
                </apply>
            </apply>
                                    
            <!-- Compute APD90, the transpose is just for plotting purposes -->
            <apply><eq/>
                <ci>APD90</ci>
                <apply><ci>Transpose</ci>
                    <apply><ci>Apd</ci>
                        <ci>steady_state_membrane_voltage</ci>
                        <ci>steady_state_time_2d</ci>
                        <cn>90</cn>
                    </apply>
                </apply>
            </apply>                     

            <!-- Get the peak voltage -->
            <apply><eq/>
                <ci>peak_voltage</ci>
                <apply><ci>Max</ci>
                    <ci>steady_state_membrane_voltage</ci>
                </apply>
            </apply>
            
            <!-- Get the resting potential, the transpose is just for plotting purposes -->
            <apply><eq/>
                <ci>resting_potential</ci>
                <apply><ci>Transpose</ci>
                    <apply><ci>Min</ci>
                        <ci>steady_state_membrane_voltage</ci>
                    </apply>
                </apply>
            </apply>
        </apply>
    </post-processing>
    
    <outputVariables>
        <raw ref="sim:membrane_voltage" name="membrane_voltage" description="Full membrane potential traces"/>
        <raw ref="sim:time" name="time" description="Full time traces"/>       
        <raw ref="sim:extracellular_potassium_concentration" name="extracellular_potassium_concentration"
            description="Extracellular potassium concentration"/>
        
        <postprocessed name="steady_state_membrane_voltage" description="Membrane voltage" units="mV"/>
        <postprocessed name="steady_state_time" description="Time" units="ms"/>
        <postprocessed name="peak_voltage" description="action potential peak voltage" units="mV"/>
        <postprocessed name="resting_potential" description="resting potential" units="mV"/>
        <postprocessed name="APD90" description="action potential duration 90%" units="ms"/>
        <postprocessed name="potassium_test_concentrations" description="[K]_o concentrations" units="mM"/>
    </outputVariables>
    
    <plots>
        <plot>
            <title>Action Potentials</title>
            <x>steady_state_time</x>
            <y>steady_state_membrane_voltage</y>
        </plot>
        <plot>
        	<title>APD_{90} as a function of [K_o]</title>
        	<x>potassium_test_concentrations</x>
        	<y>APD90</y>
        </plot>
        <plot>
        	<title>Resting potential as a function of [K]_o</title>
        	<x>potassium_test_concentrations</x>
        	<y>resting_potential</y> 
        </plot>
    </plots>
    
</protocol>
