<?xml version="1.0"?>
<?xml-model href="../../../src/proto/parsing/protocol.rnc" type="application/relax-ng-compact-syntax"?>
<?oxygen RNGSchema="../../../src/proto/parsing/protocol.rnc" type="compact"?>
<protocol xmlns="https://chaste.cs.ox.ac.uk/nss/protocol/0.1#"
    xmlns:cellml="http://www.cellml.org/cellml/1.0#"
    xmlns:oxmeta="https://chaste.comlab.ox.ac.uk/cellml/ns/oxford-metadata#">
    
    <!-- Declare protocol inputs with default values -->
    <inputs>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            <apply><eq/>
                <ci>holding_potential</ci> <!--Applied before t=0-->
                <cn>-80.01</cn>
            </apply>
            <apply><eq/>
                <ci>final_potential</ci> <!--Applied after t=50-->
                <cn>-40.01</cn>
            </apply>
            <!-- How long to simulate for to get to steady state at the holding potential -->
            <apply><eq/>
                <ci>steady_state_time</ci>
                <cn>10000</cn>
            </apply>
            <!-- Length of time to hold at test potential -->
            <apply><eq/>
                <ci>test_pulse_time</ci>
                <cn>2000</cn>
            </apply>
            <!-- Length of time to hold at test potential -->
            <apply><eq/>
                <ci>end_time</ci>
                <apply><plus/>
                    <ci>test_pulse_time</ci>
                    <cn>1000</cn>
                </apply>
            </apply>
            
            <!-- Fix some concentrations -->
            <apply><eq/>
                <ci>extracellular_potassium_concentration</ci>
                <cn>4</cn>
            </apply>
            <apply><eq/>
                <ci>cytosolic_potassium_concentration</ci>
                <cn>140</cn>
            </apply>
            <apply><eq/>
                <ci>cytosolic_sodium_concentration</ci>
                <cn>10</cn>
            </apply>
            
            <!-- The values to step the transmembrane potential to for the priming pulse (0->50 ms)-->
            <apply><eq/>
                <ci>test_potentials</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/newArray"/>
                    <cn>-70.01</cn>
                    <cn>-60.01</cn>
                    <cn>-50.01</cn>
                    <cn>-40.01</cn>
                    <cn>-30.01</cn>
                    <cn>-20.01</cn>
                    <cn>-10.01</cn>
                    <cn> 0.01</cn>
                    <cn>10.01</cn>
                    <cn>20.01</cn>
                    <cn>30.01</cn>
                    <cn>40.01</cn>
                    <cn>50.01</cn>
                </apply>
            </apply>
        </apply>
    </inputs>
    
    <import source="../../../src/proto/library/BasicLibrary.xml" prefix="std"/>
    
    <units>
        <cellml:units name="mV">
            <cellml:unit units="volt" prefix="milli"/>
        </cellml:units>
        <cellml:units name="mM">               
            <cellml:unit units="mole" prefix="milli"/>
            <cellml:unit units="litre" exponent="-1"/>
        </cellml:units>
        <cellml:units name="ms">
            <cellml:unit units="second" prefix="milli"/>
        </cellml:units>
        <cellml:units name="uA_per_cm2"> <!-- Desired units of currents -->
            <cellml:unit units="ampere" prefix="micro"/>
            <cellml:unit units="metre" prefix="centi" exponent="-2"/>
        </cellml:units>
        <cellml:units name="uF_per_cm2">
            <cellml:unit units="farad" prefix="micro"/>
            <cellml:unit units="metre" prefix="centi" exponent="-2"/>
        </cellml:units>
        <cellml:units name="microamps">
            <cellml:unit units="ampere" prefix="micro"/>
        </cellml:units>
        <cellml:units name="A_per_F">
            <cellml:unit units="ampere"/>
            <cellml:unit units="farad" exponent="-1"/>
        </cellml:units>
    </units>
    
    <modelInterface>
        <!-- Inputs into simulations -->
        <specifyInputVariable name="oxmeta:membrane_voltage" units="mV"/>
        <specifyInputVariable name="oxmeta:cytosolic_sodium_concentration" units="mM"/>
        <specifyInputVariable name="oxmeta:cytosolic_potassium_concentration" units="mM"/>
        <specifyInputVariable name="oxmeta:extracellular_potassium_concentration" units="mM"/>
        
        <!-- Model outputs we are interested in -->
        <specifyOutputVariable name="oxmeta:membrane_slow_delayed_rectifier_potassium_current" units="uA_per_cm2"/>
        <specifyOutputVariable name="oxmeta:membrane_voltage" units="mV"/>
        <specifyOutputVariable name="oxmeta:time" units="ms"/>
        
        <!-- Needed for units conversions -->
        <declareNewVariable name="chaste_membrane_capacitance" units="uF_per_cm2" initial_value="1"/>
        
        <!-- Clamp concentrations; real values will be set by modifiers -->
        <addOrReplaceEquation>
            <apply xmlns="http://www.w3.org/1998/Math/MathML"><eq/>
                <ci>oxmeta:cytosolic_sodium_concentration</ci><cn cellml:units="mM">0</cn>
            </apply>
        </addOrReplaceEquation>
        <addOrReplaceEquation>
            <apply xmlns="http://www.w3.org/1998/Math/MathML"><eq/>
                <ci>oxmeta:cytosolic_potassium_concentration</ci><cn cellml:units="mM">0</cn>
            </apply>
        </addOrReplaceEquation>
        <addOrReplaceEquation>
            <apply xmlns="http://www.w3.org/1998/Math/MathML"><eq/>
                <ci>oxmeta:extracellular_potassium_concentration</ci><cn cellml:units="mM">0</cn>
            </apply>
        </addOrReplaceEquation>

        <!-- Specify units conversions to get current in consistent units between models -->
        <unitsConversionRule desiredDimensions="uA_per_cm2" actualDimensions="A_per_F">
            <lambda xmlns="http://www.w3.org/1998/Math/MathML">
                <bvar><ci>rhs</ci></bvar>
                <apply><times/>
                    <ci>rhs</ci>
                    <ci>chaste_membrane_capacitance</ci>
                </apply>
            </lambda>
        </unitsConversionRule>
        <unitsConversionRule desiredDimensions="A_per_F" actualDimensions="uA_per_cm2">
            <lambda xmlns="http://www.w3.org/1998/Math/MathML">
                <bvar><ci>rhs</ci></bvar>
                <apply><divide/>
                    <ci>rhs</ci>
                    <ci>chaste_membrane_capacitance</ci>
                </apply>
            </lambda>
        </unitsConversionRule>
        <unitsConversionRule desiredDimensions="uA_per_cm2" actualDimensions="microamps">
            <lambda xmlns="http://www.w3.org/1998/Math/MathML">
                <bvar><ci>rhs</ci></bvar>
                <apply><times/>
                    <apply><divide/>
                        <ci>rhs</ci>
                        <ci>oxmeta:membrane_capacitance</ci>
                    </apply>
                    <ci>chaste_membrane_capacitance</ci>
                </apply>
            </lambda>
        </unitsConversionRule>
        <unitsConversionRule desiredDimensions="microamps" actualDimensions="uA_per_cm2">
            <lambda xmlns="http://www.w3.org/1998/Math/MathML">
                <bvar><ci>rhs</ci></bvar>
                <apply><divide/>
                    <apply><times/>
                        <ci>rhs</ci>
                        <ci>oxmeta:membrane_capacitance</ci>
                    </apply>
                    <ci>chaste_membrane_capacitance</ci>
                </apply>
            </lambda>
        </unitsConversionRule>
    </modelInterface>
    
    <simulations>
        <!-- Do a pre-run to get the model to steady-state for the holding potential -->
        <timecourseSimulation>
            <vectorStepper name="time" units="ms">
                <value>0</value>
                <ci xmlns="http://www.w3.org/1998/Math/MathML">steady_state_time</ci>
            </vectorStepper>
            <modifiers>
                <!-- Clamp the voltage to a holding potential -->
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:membrane_voltage</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">holding_potential</ci>
                    </value>
                </setVariable>
                <!-- Clamp concentrations of certain ionic species in certain compartments -->
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:extracellular_potassium_concentration</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">extracellular_potassium_concentration</ci>
                    </value>
                </setVariable>
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:cytosolic_potassium_concentration</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">cytosolic_potassium_concentration</ci>
                    </value>
                </setVariable>
                <setVariable>
                    <when>AT_START_ONLY</when>
                    <name>oxmeta:cytosolic_sodium_concentration</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">cytosolic_sodium_concentration</ci>
                    </value>
                </setVariable>
                <saveState>
                    <when>AT_END</when>
                    <name>holding_state</name>
                </saveState>
            </modifiers>
        </timecourseSimulation>
        
        <!-- Now do the IV curve generation -->
        <nestedSimulation prefix="sim">
            <vectorStepper name="step_voltage" units="mV">
                <ci xmlns="http://www.w3.org/1998/Math/MathML">test_potentials</ci>
            </vectorStepper>
            <modifiers>
                <!-- Reset the model's state variables to holding potential -->
                <resetState>
                    <when>EVERY_LOOP</when>
                    <state>holding_state</state>
                </resetState>                    
                <setVariable>
                    <when>EVERY_LOOP</when>
                    <name>oxmeta:membrane_voltage</name>
                    <value>
                        <ci xmlns="http://www.w3.org/1998/Math/MathML">holding_potential</ci>
                    </value>
                </setVariable>
            </modifiers>
            <timecourseSimulation>
                <uniformStepper name="time" units="ms">
                    <start>-1.0</start>
                    <stop>3000</stop>
                    <step>0.05</step>
                </uniformStepper>
                <modifiers>
                    <setVariable>
                        <when>EVERY_LOOP</when>
                        <name>oxmeta:membrane_voltage</name>
                        <value>
                            <piecewise xmlns="http://www.w3.org/1998/Math/MathML">
                                <piece>
                                    <ci>final_potential</ci>
                                    <apply><geq/>
                                        <ci>time</ci>
                                        <ci>test_pulse_time</ci>
                                    </apply>
                                </piece>    
                                <otherwise>
                                    <piecewise xmlns="http://www.w3.org/1998/Math/MathML"> 
                                        <piece>
                                            <ci>step_voltage</ci>
                                            <apply><geq/>
                                                <ci>time</ci>
                                                <cn>0</cn>
                                            </apply>
                                        </piece>
                                        <otherwise>
                                            <ci>oxmeta:membrane_voltage</ci>
                                        </otherwise>
                                    </piecewise>
                                </otherwise>
                            </piecewise>
                        </value>
                    </setVariable>
                </modifiers>
            </timecourseSimulation>
        </nestedSimulation>
    </simulations>
    
    <post-processing>
        <apply xmlns="http://www.w3.org/1998/Math/MathML">
            <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/statementList"/>
            
            <!-- Test that expected model outputs exist -->
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:time</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:membrane_voltage</ci>
                </apply>
            </apply>
            <apply>
                <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/assert"/>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/accessor">IS_ARRAY</csymbol>
                    <ci>sim:membrane_slow_delayed_rectifier_potassium_current</ci>
                </apply>
            </apply>
            
            <!-- Get out a single 1D array for time (for plotting) -->
            <apply><eq/>
                <ci>time_1d</ci>
                <apply><ci>std:RemoveDim</ci>
                     <ci>sim:time</ci>     
                     <cn>0</cn>
                </apply>
            </apply>
            
            <!-- Only examine the "tail currents" after test pulse -->
            <apply><eq/>
                <ci>IKs_tail_current</ci>
                <apply><ci>std:After</ci>
                    <ci>sim:membrane_slow_delayed_rectifier_potassium_current</ci>
                    <ci>sim:time</ci>
                    <ci>test_pulse_time</ci>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                </apply>
            </apply>
            
            <!-- Get the maximum tail current (this has the largest magnitude) as a 1d array -->
            <apply><eq/>
                <ci>max_IKs_current</ci>
                <apply><ci>std:RemoveDim</ci>
                    <apply><ci>std:Max</ci>
                        <ci>IKs_tail_current</ci>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    </apply>
                    <cn>1</cn>
                </apply>
            </apply>
            
            <!-- We'll plot against V at t=1, which is equal to the step voltage -->
            <apply><eq/>
                <ci>test_membrane_voltage</ci>
                <apply>
                    <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/view"/>
                    <apply><ci>std:After</ci>
                        <ci>sim:membrane_voltage</ci>
                        <ci>sim:time</ci>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/defaultParameter"/>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <cn>1</cn>
                        <cn>0</cn>
                        <cn>0</cn>
                        <cn>0</cn>
                    </apply>
                    <apply>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/tuple"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                        <cn>1</cn>
                        <csymbol definitionURL="https://chaste.cs.ox.ac.uk/nss/protocol/null"/>
                    </apply>
                </apply>
            </apply>
        </apply>
    </post-processing>
    
    <outputVariables>
        <raw ref="sim:membrane_slow_delayed_rectifier_potassium_current" name="membrane_slow_delayed_rectifier_potassium_current"
            description="I_{Ks} current"/>
        <raw ref="sim:membrane_voltage" name="membrane_voltage" description="Transmembrane potential"/>
        <postprocessed name="time_1d" description="Time" units="ms"/>
        <postprocessed name="IKs_tail_current" units="{/Symbol m}A/cm^2" description="I_{Ks} after test potential applied"/>
        <postprocessed name="max_IKs_current" description="Max I_{Ks} tail current" units="{/Symbol m}A/cm^2"/>
        <postprocessed name="test_membrane_voltage" units="mV" description="Test potential"/>
    </outputVariables>
    
    <plots>
        <plot>
            <title>IV curve</title>
            <x>test_membrane_voltage</x>
            <y>max_IKs_current</y>
        </plot>
        <plot>
            <title>voltage clamp</title>
            <x>time_1d</x>
            <y>membrane_voltage</y>
        </plot>
        <plot>
            <title>individual current traces</title>
            <x>time_1d</x>
            <y>membrane_slow_delayed_rectifier_potassium_current</y>
        </plot>
    </plots>
</protocol>
